---
title: LFS - Atelier 3
layout: default
category: linuq
---

LFS Atelier 3
=============

Chroot
======

Pour cet atelier, vous devez avoir votre chroot d'activé avant d'éxécuter des commandes.
Voici la commande pour activer le chroot:

    chroot "$LFS" /usr/bin/env -i \
        HOME=/root TERM="$TERM" PS1='\u:\w\$ ' \
        PATH=/bin:/usr/bin:/sbin:/usr/sbin \
        /bin/bash --login

Vous pouvez placer la commande suivante dans un script shell pour vous faciliterla tâche
lorsque vous redémarrez votre machine virtuelle :

    cat > chroot.sh << "EOF"
    #!/bin/bash
    export LFS=/mnt/lfs

    if [ ! "$(ls -A $LFS)" ]; then
        mount -t ext4 /dev/sda3 $LFS
        mount -v --bind /dev $LFS/dev
        mount -vt devpts devpts $LFS/dev/pts
        mount -vt proc proc $LFS/proc
        mount -vt sysfs sysfs $LFS/sys
        mount -vt tmpfs shm $LFS/dev/shm
    fi

    chroot "$LFS" /usr/bin/env -i \
        HOME=/root TERM="$TERM" PS1='\u:\w\$ ' \
        PATH=/bin:/usr/bin:/sbin:/usr/sbin \
        /bin/bash --login

    EOF

Réseau
======

Avant tout, nous allons ajuster l'adresse MAC de notre interface reseau.
Executez la commande suivante puis notez la adresse MAC:

    ip a

    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN 
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
        link/ether 08:00:27:ed:ee:9c brd ff:ff:ff:ff:ff:ff
        inet 192.168.56.102/24 brd 192.168.56.255 scope global eth0
        inet6 fe80::a00:27ff:feed:ee9c/64 scope link 
           valid_lft forever preferred_lft forever

ensuite, allez modifier le fichier udev puis ajutez votre adresse mac

    vim /etc/udev/rules.d/70-persistent-net.rules

Vous allez retrouver une configuration comme suit:

    # This file was automatically generated by the /lib/udev/write_net_rules
    # program, run by the persistent-net-generator.rules rules file.
    #
    # You can modify it, as long as you keep each rule on a single
    # line, and change only the value of the NAME= key.

    # PCI device 0x8086:0x100e (e1000)
    SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:ed:ee:9c", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

eth0
----

Nous allons commencer par créer un fichier de configuration pour notre
interface réseau. Le premier fichier à créer est /etc/sysconfig/ifconfig.eth0

    cd /etc/sysconfig/
    cat > ifconfig.eth0 << "EOF"
    ONBOOT=yes
    IFACE=eth0
    SERVICE=ipv4-static
    IP=192.168.1.10
    GATEWAY=192.168.1.1
    PREFIX=24
    BROADCAST=192.168.1.255
    EOF


/etc/resolv.conf
----------------

Resolv.conf contient la configuration pour accèder à des serveurs DNS lorsque
vous faites des opérations de réseau sur internet.

    cat > /etc/resolv.conf << "EOF"
    # Begin /etc/resolv.conf

    nameserver 8.8.8.8
    nameserver 8.8.4.4

    # End /etc/resolv.conf
    EOF


/etc/hosts
----------

/etc/hosts contient la configuration sur les adresses IPs statiques. Même si une
machine n'a pas de connexion réseau, elle doit avoir un nom réseau d'attribué à fin
d'assurer le bon fonctionnement du système.

    cat > /etc/hosts << "EOF"
    # Begin /etc/hosts (network card version)

    127.0.0.1 localhost
    192.168.1.1 atelier.lfs.localdomain

    # End /etc/hosts (network card version)
    EOF

/etc/sysconfig/network
----------------------

/etc/sysconfig/network contient le nom de la machine sur le réseau.

    echo "HOSTNAME=atelier" > /etc/sysconfig/network

Bootscripts
===========

Pour installer les scripts de démarrage du système :

    cd /sources
    tar xf lfs-bootscripts-20130123.tar.bz2
    cd lfs-bootscripts-20130123
    make install

Ensuite il faut aller configurer inittab, le fichier de configuration de sysinit,
le système de démarrage.

    cat > /etc/inittab << "EOF"
    # Begin /etc/inittab

    id:3:initdefault:

    si::sysinit:/etc/rc.d/init.d/rc S

    l0:0:wait:/etc/rc.d/init.d/rc 0
    l1:S1:wait:/etc/rc.d/init.d/rc 1
    l2:2:wait:/etc/rc.d/init.d/rc 2
    l3:3:wait:/etc/rc.d/init.d/rc 3
    l4:4:wait:/etc/rc.d/init.d/rc 4
    l5:5:wait:/etc/rc.d/init.d/rc 5
    l6:6:wait:/etc/rc.d/init.d/rc 6

    ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now

    su:S016:once:/sbin/sulogin

    1:2345:respawn:/sbin/agetty --noclear tty1 9600
    2:2345:respawn:/sbin/agetty tty2 9600
    3:2345:respawn:/sbin/agetty tty3 9600
    4:2345:respawn:/sbin/agetty tty4 9600
    5:2345:respawn:/sbin/agetty tty5 9600
    6:2345:respawn:/sbin/agetty tty6 9600

    # End /etc/inittab
    EOF

Horloge
=======

/etc/sysconfig/clock permet de configurer si l'horloge du système est en UTC ou non.
À fin de simplifier la gestion du temps, nous allons configurer le système en mode
UTC.

    cat > /etc/sysconfig/clock << "EOF"
    # Begin /etc/sysconfig/clock

    UTC=1

    # Set this to any options you might need to give to hwclock,
    # such as machine hardware clock type for Alphas.
    CLOCKPARAMS=

    # End /etc/sysconfig/clock
    EOF

Console
=======

/etc/console permet de configurer le layout clavier qui sera utilisé lorsque
vous utilisez votre clavier dans une console.

    cat > /etc/sysconfig/console << "EOF"
    # Begin /etc/sysconfig/console

    KEYMAP="us"
    FONT="lat1-16 -m 8859-1"

    # End /etc/sysconfig/console
    EOF

rc.site
=======

Le fichier /etc/sysconfig/rc.site permet de configurer divers paramètres de base
du système. Pour nos besoins, nous n'avons pas besoin de modifier les paramètres par
défaut.


/etc/profile
===========

/etc/profile permet de configurer les paramètres d'internationalisation, comme 
la langue et le signe de la monnaie courante. Nous allons configurer LFS en
canadien francais

    cat > /etc/profile << "EOF"
    # Begin /etc/profile

    export LANG=fr_CA.utf8
    PS1="\u [ \w ]# "

    # End /etc/profile
    EOF


/etc/inputrc
============

/etc/inputrc permet de configurer readline, la librairie utilisé pour offir
des raccourcis et autres utilitaires de la console. Voici un fichier avec une
configuration générique.

    cat > /etc/inputrc << "EOF"
    # Begin /etc/inputrc
    # Modified by Chris Lynn <roryo@roryo.dynup.net>

    # Allow the command prompt to wrap to the next line
    set horizontal-scroll-mode Off

    # Enable 8bit input
    set meta-flag On
    set input-meta On

    # Turns off 8th bit stripping
    set convert-meta Off

    # Keep the 8th bit for display
    set output-meta On

    # none, visible or audible
    set bell-style none

    # All of the following map the escape sequence of the value
    # contained in the 1st argument to the readline specific functions
    "\eOd": backward-word
    "\eOc": forward-word

    # for linux console
    "\e[1~": beginning-of-line
    "\e[4~": end-of-line
    "\e[5~": beginning-of-history
    "\e[6~": end-of-history
    "\e[3~": delete-char
    "\e[2~": quoted-insert

    # for xterm
    "\eOH": beginning-of-line
    "\eOF": end-of-line

    # for Konsole
    "\e[H": beginning-of-line
    "\e[F": end-of-line

    # End /etc/inputrc
    EOF

/etc/fstab
==========

/etc/fstab contient la configuration des partitions du système. Voici 
une configuration de base pour notre système LFS

    cat > /etc/fstab << "EOF"
    # Begin /etc/fstab

    # file system  mount-point  type     options             dump  fsck
    #                                                              order

    /dev/sda3      /            ext4     defaults            1     1
    /dev/sda2      swap         swap     pri=1               0     0
    proc           /proc        proc     nosuid,noexec,nodev 0     0
    sysfs          /sys         sysfs    nosuid,noexec,nodev 0     0
    devpts         /dev/pts     devpts   gid=5,mode=620      0     0
    tmpfs          /run         tmpfs    defaults            0     0
    devtmpfs       /dev         devtmpfs mode=0755,nosuid    0     0

    # End /etc/fstab
    EOF

Compilation kernel
==================

**Temps de compilation:** 23m

Commencons par décompresser le paquet du kernel

    cd /sources
    tar xf linux-3.8.1.tar.xz
    cd linux-3.8.1
    make mrproper

Rendu ici, il faut configurer le kernel selon ses préférences.

À ne pas oublier :

    Device Drivers  --->
        Generic Driver Options  --->
            Maintain a devtmpfs filesystem to mount at /dev (on)

    File systems -->
        Second extended fs support 
            Ext2 extended attributes
                Ext2 POSIX Access Control Lists
                Ext2 Security Labels
            Ext3 journalling file system support
            The Extended 4 (ext4) filesystem
                Ext4 POSIX Access Control Lists
                Ext4 Security Labels

Options pas nécessaires mais qui réduisent le temps de compilation

    Networking support
        Amateur Radio support (off)
    Device Drivers
        Serial ATA and Parallel ATA drivers
            AMD/Nvidia PATA support (off)
            Intel SCH PATA support (off)
    Multiple devices driver support (RAID and LVM) (off)
    Macintosh device drivers (off)
        Network device support
            FDDI driver support (off)
            Wireless LAN (off)
            Ethernet driver support
                !!!Everything off except Intel!!!
            Input device support
                Joysticks/Gamepads (off)
                Tablets (off)
                Touchscreens (off)
                Miscellaneous devices (off)
            Watchdog Timer Support (off)
            Sound card support
                Advanced Linux Sound Architecture
                    USB sound devices (off)
                    PCMCIA sound devices (off)
            HID support
                Special HID Drivers
                    !!!Everything off!!!


Ensuite, on compile

    make

On installe les modules puis le kernel lui-même

    make modules_install
    cp -v arch/x86/boot/bzImage /boot/vmlinuz-3.8.1-lfs-7.3
    cp -v System.map /boot/System.map-3.8.1
    cp -v .config /boot/config-3.8.1

Puis on installe la documentation

    install -d /usr/share/doc/linux-3.8.1
    cp -r Documentation/* /usr/share/doc/linux-3.8.1

Finalement, on place un fichier de configuration pour le chargement des modules

    install -v -m755 -d /etc/modprobe.d
    cat > /etc/modprobe.d/usb.conf << "EOF"
    # Begin /etc/modprobe.d/usb.conf

    install ohci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i ohci_hcd ; true
    install uhci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i uhci_hcd ; true

    # End /etc/modprobe.d/usb.conf
    EOF

Grub
====

Installons grub au MBR

    grub-install /dev/sda

Création du fichier de configuration GRUB

    cat > /boot/grub/grub.cfg << "EOF"
    # Begin /boot/grub/grub.cfg
    set default=0
    set timeout=5

    insmod ext2
    set root=(hd0,3)

    menuentry "GNU/Linux, Linux 3.8.1-lfs-7.3" {
            linux   /boot/vmlinuz-3.8.1-lfs-7.3 root=/dev/sda3 ro
    }
    EOF

Reboot
======

Il ne reste plus qu'à croiser les doigts et redémarrer !
